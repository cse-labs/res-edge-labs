#!/bin/bash

k3d="$CLI_BOA_DIR/k3d.yaml"
# validate directories
if [ ! -f "$k3d" ]; then
	k3d="$CLI_BIN_DIR/.$CLI_BIN_NAME/k3d.yaml"

	if [ ! -f "$k3d" ]; then
		echo "File not found - $k3d"
		exit 1
	fi
fi

kic cluster delete

echo ""
echo "Creating cluster ..."

k3d cluster create \
    --k3s-arg '--no-deploy=traefik@server:0' \
    --config "$k3d"

exit 0

echo "waiting for cluster to start"
sleep 10
kubectl wait pods -n kube-system -l k8s-app=kube-dns --for condition=Ready --timeout=30s

cd "$KIC_BASE/.gitops/clusters/lab-01/flux-system"
git pull

kubectl apply -f namespace.yaml

# create the Flux secret
# the PAT must have permissions to the repo
flux create secret git flux-system -n flux-system --url https://github.com/cse-labs/pizza-labs -u gitops -p $PAT

# deploy the Flux components
kubectl apply -f components.yaml

# create the Flux Source
kubectl apply -f source.yaml

# this single kustomization will manage all of the kustomizations generated by Res-Edge-Automation
kubectl apply -f flux-kustomization.yaml

# check pods for cert-manager and heartbeat
kubectl get pods -A --watch
