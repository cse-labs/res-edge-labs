# GitOps

## Create a new Codespace

- todo - decide how we want the labs to flow

- for testing, you can use the same Codespace
- if you do, you will need to recreate your cluster
  - deploy res-edge
  - assign group to namespace
  - run `ds cicd`
  - push to git repo
- we can reorder the labs so you don't have to re-deploy
- I like the separation of "Res-Edge cluster" and "member cluster" (central-la-nola-2301)

## Set Personal Access Token

```bash

export KIC_PAT=<yourGitHubPAT>

```

## Set environment variables

- Set any of these env vars that are not set correctly
- todo - we can set everything except PAT in on-create and delete this section

```bash

echo $KIC_FULL_REPO

echo $KIC_PAT

echo $KIC_BRANCH

```

## Create a New Cluster

- Use `kic` to create and verify a new k3d cluster in the new Codespace

```bash

# delete and create a new cluster
kic cluster create

# wait for pods to get to Running
kic pods --watch

```

## Deploy GitOps (Flux v2)

- This deploys GitOps (Flux) to your cluster

```bash

# todo - move this to /clusters
# note: currently, the repo and branch are hard-coded in the yaml
# you will need to edit source.yaml to use a different repo / branch

cd "$REPO_BASE/deploy/central-la-nola-2301/flux-system"

# deploy the Flux components
kubectl apply -f components.yaml

# create the Flux secret
flux create secret git flux-system -n flux-system --url "$KIC_FULL_REPO" -u gitops -p "$KIC_PAT"

# create the Flux Source
kubectl apply -f source.yaml

# check the source
flux get all

# create the Flux Kustomization
# this single kustomization will manage all of the kustomizations generated by Res-Edge-Automation (GitOps)
kubectl apply -f flux-kustomization.yaml

# check the source and kustomizations
flux get all

# check the kustomizations
# todo - change kic check flux to use "flux get all" instead of "flux get kustomizations"
kic check flux

```

## Force Flux to Sync

- After making changes, you can force Flux to sync (reconcile)

```bash

# todo - this is currently broken
kic sync

```

## Verify Flux Deployment

```bash

# make sure the pods Flux deployed are running
kic check pods --watch

# check heartbeat
kic check heartbeat

# check imdb
kic check imdb

# check redis
# todo - need to implement
kic check redis

```

## Flux Setup Files

> todo - need to add the flux app and generate in ci-cd

- The Flux setup yaml is located in `deploy/central-la-nola-2301/flux-system`
  - A `Flux source` is a git repo / branch combination
  - A `Flux kustomization` is a directory within the source
    - We have 3 kustomizations
      - flux-kustomization watches the flux-system/listeners directory
      - Res-Edge-Automation creates listeners for each Namespace in this directory
    - You want to have multiple kustomizations (or helm)
      - When a kustomization fails, the entire process is aborted
        - This lets "your app" break "my app"
      - We create a kustomization per Namespace as part of Res-Edge-Automation (`ds cicd`)
