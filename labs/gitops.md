# GitOps

## Flux Setup Files

- The Flux setup yaml is located in `clusters/central-la-nola-2301/flux-system`
  - A `Flux source` is a git repo / branch combination
  - A `Flux kustomization` is a directory within the source
    - flux-kustomization watches the flux-system and flux-system/listeners directories
    - You want to have multiple kustomizations
      - When a kustomization fails, the entire process is aborted
        - This lets "your app" break "my app"
      - We create a kustomization per Namespace as part of Res-Edge-Automation (`ds cicd`)
- You can use any cluster in the clusters directory

## Prerequisites

- Deploy the Res-Edge [data service](./deploy-res-edge/README.md)
- Assign a Group to the [imdb Namespace](./assign-group-to-namespace.md)

## Create a new Codespace

- Create a new Codespace that will be a "member cluster"
- We will use GitOps to deploy workloads to the cluster in the new Codespace

## In the new Codespace

- Verify the K8s cluster is running

  ```bash

  kic pods --watch

  ```

## Set Env Vars

- We use the GITHUB_TOKEN for convenience
  - Your GITHUB_TOKEN will expire after about a week
  - GitOps will fail once the token expires

- For long running GitOps, you need to create a GitHub Personal Access Token (PAT)
  - `export KIC_PAT=<YourGitHubPat>`

```bash

export KIC_FULL_REPO=$(git remote get-url --push origin)
export KIC_BRANCH=$(git branch --show-current)

if [ "$KIC_PAT" = "" ]; then
  export KIC_PAT=$GITHUB_TOKEN
fi

env | grep KIC_

```

## Update Flux Template

- Edit apps/flux-system/source.yaml
  - Update `url:` and `branch:`

    ```bash

    code apps/flux-system/source.yaml

    ```

## Deploy GitOps (Flux v2)

- This deploys GitOps (Flux) to your cluster

```bash

cd "$REPO_BASE/clusters/central-la-nola-2301/flux-system"

# create the namespace
kubectl apply -f namespace.yaml

# create the Flux secret
flux create secret git flux-system -n flux-system --url "$KIC_FULL_REPO" -u gitops -p "$KIC_PAT"

# deploy the Flux components
kubectl apply -f components.yaml

# create the Flux Source
kubectl apply -f source.yaml

# create the Flux Kustomization
# this single kustomization will manage all of the kustomizations generated by Res-Edge-Automation
kubectl apply -f flux-kustomization.yaml

# check flux
kic check flux

```

## Force Flux to Sync

- After making changes, you can force Flux to sync (reconcile)

```bash

kic sync

```

## Verify Flux Deployment

```bash

# make sure the pods Flux deployed are running
kic check pods --watch

# check heartbeat
kic check heartbeat

# check redis
kic check redis

# check imdb
kic check imdb

```
